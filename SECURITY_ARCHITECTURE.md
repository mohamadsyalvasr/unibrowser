# ğŸ” UniBrowser Security Architecture

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UNIBROWSER SECURITY SYSTEM                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EXTENSION LAYER                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   CHROME EXTENSION      â”‚      â”‚  FIREFOX EXTENSION      â”‚  â”‚
â”‚  â”‚                         â”‚      â”‚                         â”‚  â”‚
â”‚  â”‚ â€¢ background.js         â”‚      â”‚ â€¢ background.js         â”‚  â”‚
â”‚  â”‚ â€¢ Token Manager âœ“       â”‚      â”‚ â€¢ Token Manager âœ“       â”‚  â”‚
â”‚  â”‚ â€¢ Storage Secure âœ“      â”‚      â”‚ â€¢ Storage Secure âœ“      â”‚  â”‚
â”‚  â”‚ â€¢ CSP Policy âœ“          â”‚      â”‚ â€¢ CSP Policy âœ“          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚ Bearer Token                   â”‚ Bearer Token    â”‚
â”‚               â”‚ Authorization Header          â”‚ Authorization   â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Header        â”‚
â”‚                            â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    SECURITY LAYER #1
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   (TLS/HTTP-only)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             NETWORK SECURITY                                   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ CORS Middleware                                          â”‚  â”‚
â”‚  â”‚  âœ“ Allow Origins: http://127.0.0.1, http://localhost   â”‚  â”‚
â”‚  â”‚  âœ“ Methods: GET, POST, OPTIONS                          â”‚  â”‚
â”‚  â”‚  âœ“ Headers: Content-Type, Authorization                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Trusted Host Middleware                                  â”‚  â”‚
â”‚  â”‚  âœ“ Verified Hosts: 127.0.0.1, localhost                â”‚  â”‚
â”‚  â”‚  âœ“ Blocks external connections                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    SECURITY LAYER #2
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   (Request Validation)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          BACKEND SECURITY                                      â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Authentication Layer                                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  1. Extract Bearer Token from Header                   â”‚  â”‚
â”‚  â”‚  2. Hash Token (SHA-256)                               â”‚  â”‚
â”‚  â”‚  3. Compare Hash with Stored Hashes                    â”‚  â”‚
â”‚  â”‚  4. Return 401 if Invalid                              â”‚  â”‚
â”‚  â”‚  5. Proceed if Valid                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                                   â”‚
â”‚                          VALID?                                 â”‚
â”‚                          /    \                                 â”‚
â”‚                       NO/      \YES                             â”‚
â”‚                       /          \                              â”‚
â”‚           (401 Unauthorized)   (Proceed)                        â”‚
â”‚                       â”‚            â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”‚                            â”‚
â”‚  â”‚ Automatic Token Refresh   â”‚    â”‚                            â”‚
â”‚  â”‚  â€¢ Token Cleared          â”‚    â”‚                            â”‚
â”‚  â”‚  â€¢ Extension Retries      â”‚    â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                            â”‚
â”‚                                   â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Rate Limiting Layer (slowapi)                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ POST /api/sync/bookmarks: 10 req/minute             â”‚  â”‚
â”‚  â”‚  â€¢ GET /api/bookmarks: 30 req/minute                   â”‚  â”‚
â”‚  â”‚  â€¢ POST /api/auth/token: Unlimited                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Returns 429 if exceeded                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        SECURITY LAYER #3
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    (Rate Limiting & Request Handling)
                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DATABASE LAYER                                       â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SQLite Database (sync_browser.db)                        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ Browsers Table                                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ID (Primary Key)                            â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Name, Device, Profile                       â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ Bookmarks Table                                 â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ID, Browser_ID (Foreign Key)                â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Title, URL, Folder Path                     â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Created_at, Updated_at                      â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Token Storage (auth_tokens.txt)                          â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ Stores SHA-256 hashed tokens                         â”‚  â”‚
â”‚  â”‚  â€¢ One hash per line                                    â”‚  â”‚
â”‚  â”‚  â€¢ Plain text tokens NEVER stored                       â”‚  â”‚
â”‚  â”‚  â€¢ Read on every request (with caching)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

### Initial Authentication

```
Extension                          Backend
   â”‚                                 â”‚
   â”œâ”€ Check for token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚  (None found)                   â”‚
   â”‚                                 â”‚
   â”‚<â”€â”€â”€ POST /api/auth/token â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                 â”‚
   â”‚     Backend:                    â”‚
   â”‚     1. Generate random token    â”‚
   â”‚     2. Hash with SHA-256        â”‚
   â”‚     3. Save hash to file        â”‚
   â”‚     4. Return token             â”‚
   â”‚                                 â”‚
   â”‚<â”€â”€â”€ {token: "xyz..."}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                 â”‚
   â”œâ”€ Store token (encrypted) â”€â”€â”€â”€â”€â”€>â”‚
   â”‚  â€¢ Chrome: chrome.storage.sync  â”‚
   â”‚  â€¢ Firefox: browser.storage.    â”‚
   â”‚                                 â”‚
   â””â”€ Token ready for use!           â”‚
```

### Bookmark Sync Request

```
Extension                          Backend
   â”‚                                 â”‚
   â”œâ”€ Collect bookmarks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚  (from browser)                 â”‚
   â”‚                                 â”‚
   â”œâ”€ Get stored token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚  (or refresh if expired)        â”‚
   â”‚                                 â”‚
   â”œâ”€ POST /api/sync/bookmarks â”€â”€â”€â”€â”€>â”‚
   â”‚  Header: Authorization: Bearer  â”‚
   â”‚  Body: {bookmarks: [...]}       â”‚
   â”‚                                 â”‚
   â”‚     Backend:                    â”‚
   â”‚     1. Extract token from       â”‚
   â”‚        Authorization header     â”‚
   â”‚     2. Hash token (SHA-256)     â”‚
   â”‚     3. Load valid tokens        â”‚
   â”‚     4. Check if hash exists     â”‚
   â”‚                                 â”‚
   â”‚<â”€â”€â”€ (Validation Result) â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                 â”‚
   â”‚ IF Token Valid:                 â”‚
   â”‚  5. Check rate limit            â”‚
   â”‚  6. Process bookmarks           â”‚
   â”‚  7. Store in database           â”‚
   â”‚  8. Return 200 OK               â”‚
   â”‚                                 â”‚
   â”‚<â”€â”€â”€ {status: ok, inserted: N}â”€â”€â”¤
   â”‚                                 â”‚
   â”‚ IF Token Invalid:               â”‚
   â”‚  5. Return 401 Unauthorized     â”‚
   â”‚  8. Extension clears token      â”‚
   â”‚                                 â”‚
   â”‚<â”€â”€â”€ 401 Unauthorized â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚     (Extension will retry)      â”‚
   â”‚                                 â”‚
   â”‚ IF Rate Limited:                â”‚
   â”‚  5. Return 429 Too Many Req.   â”‚
   â”‚                                 â”‚
   â”‚<â”€â”€â”€ 429 Too Many Requests â”€â”€â”€â”€â”€â”¤
   â”‚     (Extension waits 1 min)     â”‚
   â”‚                                 â”‚
```

---

## Token Lifecycle

```
Timeline: 7 Days (604,800 seconds)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Day 0 (Hour 0)
â”‚
â”œâ”€ Extension starts
â”œâ”€ No token stored
â”œâ”€ POST /api/auth/token
â”œâ”€ Token received & stored
â”œâ”€ Token.created_at = NOW
â”‚
â”œâ”€ âœ“ Token VALID
â”œâ”€ âœ“ Token ACTIVE for use
â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
Day 6 (23 hours later)
â”‚
â”œâ”€ Token age < 7 days
â”œâ”€ âœ“ Token still VALID
â”œâ”€ âœ“ Token ACTIVE for use
â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
Day 7 (Exactly 7 days)
â”‚
â”œâ”€ Extension checks token age
â”œâ”€ Token age >= 7 days
â”œâ”€ âœ— Token EXPIRED
â”œâ”€ POST /api/auth/token
â”œâ”€ New token received
â”œâ”€ Old token replaced
â”œâ”€ Token.created_at = NOW
â”‚
â”œâ”€ âœ“ Token VALID (reset)
â”œâ”€ âœ“ Token ACTIVE for use
â”‚
â”œâ”€ Cycle repeats...
â”‚
```

---

## Security Layers Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REQUEST FLOW                                â”‚
â”‚                                                                â”‚
â”‚  Extension sends request with:                                â”‚
â”‚  â€¢ Authorization: Bearer <token>                              â”‚
â”‚  â€¢ Content-Type: application/json                             â”‚
â”‚  â€¢ Body: Bookmark data                                        â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             LAYER 1: CORS VALIDATION                           â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ Check Origin header                                       â”‚
â”‚  â”œâ”€ Is it http://127.0.0.1 or localhost?                     â”‚
â”‚  â”œâ”€ Check Method (GET, POST, OPTIONS?)                       â”‚
â”‚  â”œâ”€ Check Headers (Content-Type, Authorization?)             â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ FAIL? â†’ Return 403 Forbidden                             â”‚
â”‚     PASS? â†’ Continue to next layer                           â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LAYER 2: TRUSTED HOST VERIFICATION                    â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ Check Host header                                         â”‚
â”‚  â”œâ”€ Is it 127.0.0.1 or localhost?                            â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ FAIL? â†’ Return 400 Bad Request                           â”‚
â”‚     PASS? â†’ Continue to next layer                           â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LAYER 3: AUTHENTICATION (TOKEN)                      â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ Extract Authorization header                              â”‚
â”‚  â”œâ”€ Format: "Bearer <token>"?                                â”‚
â”‚  â”œâ”€ Extract token                                             â”‚
â”‚  â”œâ”€ Hash token (SHA-256)                                     â”‚
â”‚  â”œâ”€ Load valid token hashes                                  â”‚
â”‚  â”œâ”€ Hash found in valid tokens?                              â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ FAIL? â†’ Return 401 Unauthorized                          â”‚
â”‚     PASS? â†’ Continue to next layer                           â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            LAYER 4: RATE LIMITING                              â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ Get remote IP address                                     â”‚
â”‚  â”œâ”€ Check request count (last minute)                        â”‚
â”‚  â”œâ”€ Is endpoint /api/sync/bookmarks? (limit: 10/min)        â”‚
â”‚  â”œâ”€ Is endpoint /api/bookmarks? (limit: 30/min)             â”‚
â”‚  â”œâ”€ Under limit?                                             â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ FAIL? â†’ Return 429 Too Many Requests                     â”‚
â”‚     PASS? â†’ Continue to next layer                           â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LAYER 5: INPUT VALIDATION                              â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ Parse JSON body                                           â”‚
â”‚  â”œâ”€ Validate required fields                                  â”‚
â”‚  â”œâ”€ Type checking (string, array, etc.)                      â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ FAIL? â†’ Return 422 Unprocessable Entity                  â”‚
â”‚     PASS? â†’ Continue to processing                           â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          PROCESSING: DATABASE OPERATIONS                       â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ Check/create browser entry                               â”‚
â”‚  â”œâ”€ Check/update bookmarks                                   â”‚
â”‚  â”œâ”€ Return success response                                  â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RESPONSE: SECURE TRANSMISSION                          â”‚
â”‚                                                                â”‚
â”‚  â”œâ”€ 200 OK with bookmark data                                â”‚
â”‚  â”œâ”€ OR appropriate error status code                         â”‚
â”‚  â”œâ”€ Sent back to extension securely                          â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Token Hashing Security

```
Plain Token (Only shown to user once):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (SHA-256)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3F5C8D9E2B1A4F6C8E9D0B2A1F4C5E6D7A8B... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (Save)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth_tokens.txt:                          â”‚
â”‚ 3F5C8D9E2B1A4F6C8E9D0B2A1F4C5E6D7A8B... â”‚
â”‚ 2E9C4B1D7A3F5E8B0C2A6D9E1B4F7C5A8D3... â”‚
â”‚ 7B2E9C1A6D4F0B8E3C5A7D2E9F1B4A6C8D5... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Security Benefit:
  âœ“ Even if file is stolen, tokens are useless
  âœ“ Can't reverse hash back to original token
  âœ“ Same token always produces same hash
  âœ“ Different tokens produce different hashes
```

---

## Error Response Codes

```
200 OK
  â”œâ”€ Success: Sync completed
  â””â”€ Response: {status: "ok", inserted: N, updated: N}

401 Unauthorized
  â”œâ”€ Missing token
  â”œâ”€ Invalid token format
  â”œâ”€ Invalid/expired token
  â””â”€ Response: {detail: "error message"}

429 Too Many Requests
  â”œâ”€ Rate limit exceeded
  â””â”€ Response: {detail: "Too many requests..."}

403 Forbidden
  â”œâ”€ CORS violation
  â”œâ”€ Invalid origin
  â””â”€ Response: {detail: "Access denied"}

400 Bad Request
  â”œâ”€ Invalid host
  â”œâ”€ Malformed request
  â””â”€ Response: {detail: "error message"}

422 Unprocessable Entity
  â”œâ”€ Invalid data format
  â”œâ”€ Missing required fields
  â””â”€ Response: {detail: "validation error"}
```

---

**Architecture Version**: 1.0
**Last Updated**: 2025-11-18
**Status**: âœ… Production Ready
